local PidNumber = 0
local PacketPidName = {}
local PacketPidNumber = {}

local function pidAccumulator(segment)
    PidNumber = segment or PidNumber + 1
    return PidNumber
end

function Packet.RegisterPacketPid(name)
    if not PacketPidName[name] then
        local value = pidAccumulator()
        PacketPidName[name] = value
        PacketPidNumber[value] = name
    end
end

local function pidToName(pid)
    return PacketPidNumber[pid] or pid
end

local function pidToNumber(pid)
    return PacketPidName[pid] or pid
end

local StructNumber = 0
local PacketStructName = {}
local PacketStructNumber = {}

local function structAccumulator(segment)
    StructNumber = segment or StructNumber + 1
    return StructNumber
end

function Packet.RegisterPacketStruct(name)
    if not PacketStructName[name] then
        local value = structAccumulator()
        PacketStructName[name] = value
        PacketStructNumber[value] = name
    end
end

local function encode(data)
    local newData = {}
    for k, v in pairs(data) do
        if PacketStructName[k] then
            newData[PacketStructName[k]] = v
        else
            --print('encode key not found  --------------------- ' .. k)
            newData[k] = v
        end
    end
    return newData
end

local function decode(data)
    local newData = {}
    if type(data) == "table" then
        for k, v in pairs(data) do
            if PacketStructNumber[k] then
                newData[PacketStructNumber[k]] = v
            else
                --print('encode key not found  --------------------- ' .. k)
                newData[k] = v
            end
        end
    end
    return newData
end

function Packet.Encode(data)
    data.pid = pidToNumber(data.pid)
    data = encode(data)
    return data
end

function Packet.Decode(data)
    data = decode(data)
    data.pid = pidToName(data.pid)
    return data
end

local PacketName = {
    "GM",
    "ping",
    "resp",
    "DoCmd",
    "BtsMsg",
    "GMList",
    "Reload",
    "BuffMap",
    "PetList",
    "AddBuff",
    "ShowTip",
    "SetProp",
    "KillTip",
    "Rebirth",
    "BuyShop",
    "GameInfo",
    "SkillMap",
    "RankData",
    "ShowRank",
    "SyncShop",
    "HandItem",
    "ShowShop",
    "HeadText",
    "SyncTask",
    "ShowHome",
    "ShowTask",
    "tray_new",
    "tray_del",
    "ShowEdge",
    "SyncProp",
    "BuyVoice",
    "ExitGame",
    "PetPutOn",
    "SellItem",
    "TaskList",
    "DoCmdRet",
    "NextGame",
    "RedoEdit",
    "UndoEdit",
    "ChangeMap",
    "CastSkill",
    "StopSkill",
    "OnWatchAd",
    "tray_load",
    "tray_stat",
    "slot_stat",
    "OpenChest",
    "SetRegion",
    "DelRegion",
    "GMSubList",
    "OpenStore",
    "SyncStore",
    "EntityFly",
    "PauseGame",
    "ChunkData",
    "DoCompund",
    "PlayerCmd",
    "EquipItem",
    "SellItems",
    "GuideStep",
    "StartTask",
    "AbortTask",
    "LikeParty",
    "ReportFPS",
    "CreateTeam",
    "SyncWallet",
    "RemoveBuff",
    "AddSceneUI",
    "EntityDead",
    "EntityMove",
    "SystemChat",
    "ShowNotice",
    "ShowSelect",
    "StartSkill",
    "DamageText",
    "SkinChange",
    "GMInputBox",
    "MarkEntity",
    "SetBgmRate",
    "StartTrade",
    "TradeClose",
    "TradeReset",
    "lockVision",
    "TouchBlock",
    "SyncVarVal",
    "TakePhotos",
    "OpenSignIn",
    "BeAttacked",
    "BuySuccess",
    "SwitchItem",
    "PetTakeOff",
    "DoCallBack",
    "DeleteItem",
    "DropDamage",
    "FinishTask",
    "RecipeList",
    "EquipSkill",
    "RenewParty",
    "LeaveParty",
    "CloseParty",
    "BreakTrade",
    "ItemUnlock",
    "SaveRegion",
    "DismissTeam",
    "EntitySpawn",
    "EntityValue",
    "ChangeActor",
    "ChatMessage",
    "ShowRoutine",
    "StageExited",
    "SendGameEnd",
    "tray_reload",
    "Play3dSound",
    "Stop3dSound",
    "ServerError",
    "SceneUIOpen",
    "ShowNewShop",
    "ShowBgmList",
    "SyncFlyMode",
    "ClientReady",
    "combineItem",
    "PlayerEnter",
    "PlayerLeave",
    "LoadChapter",
    "ItemUpgrade",
    "CreateParty",
    "AcceptTrade",
    "RefuseTrade",
    "PlayAnimoji",
    "AbandonItem",
    "SetGameState",
    "EntityRideOn",
    "StageEndTime",
    "SetCameraYaw",
    "SetEntityYaw",
    "SetTextFlash",
    "ShowRecharge",
    "SubmitRecipe",
    "OpenNpcChest",
    "UpdateRegion",
    "delMapEffect",
    "ShowNewRanks",
    "UnMarkEntity",
    "RequestTrade",
    "TradeRefused",
    "TradeSucceed",
    "ShowTeamInfo",
    "AddMainGains",
    "ShowSellShop",
    "playerEffect",
    "ShowGoldShop",
    "PickDropItem",
    "BlindBoxInit",
    "LuckyLottery",
    "BlindBoxOpen",
    "ShowToastTip",
    "SyncBuyShops",
    "SortTypeTray",
    "SyncViewInfo",
    "StopCompound",
    "StartPlayBGM",
    "GetGoodsInfo",
    "ConfirmTrade",
    "RemoveRegion",
    "OnPlayerLogin",
    "SetPlayerTeam",
    "StudySkillMap",
    "RemoveSceneUI",
    "CreateSceneUI",
    "SetLayout",
    "SetAlwaysOnTop",
    "SetAlwaysFaceCamera",
    "SetViewDistance",
    "SetScaleWithDistance",
    "SetPosition",
    "SetRotation",
    "SetLockWorldRotation",
    "DropItemSpawn",
    "ObjectRemoved",
    "EntityRebirth",
    "EntityRideOff",
    "RankDataDirty",
    "AddWaitDealUI",
    "ShowInfoPanel",
    "PlayHeartbeat",
    "StopHeartbeat",
    "RemoveMapIcon",
    "ShowBuyRevive",
    "ShowDialogTip",
    "setEntityView",
    "FillBlockMask",
    "playMapEffect",
    "ShowPartyList",
    "SetEntityName",
    "HeadCountDown",
    "ShowInviteTip",
    "HideOpenedWnd",
    "ShowOpenedWnd",
    "UpdateAnimoji",
    "PromptPayment",
    "AddUnmilitRes",
    "onShowFlyText",
    "PlayerFriends",
    "EspShopCommit",
    "ClientTrigger",
    "RoutineCommit",
    "SplitTrayItem",
    "GetSignInData",
    "StartCompound",
    "OnPlayerVisit",
    "TransferPoint",
    "UIBehaviorLog",
    "NewEditObject",
    "exchangeCDKey",
    "SyncPlayerName",
    "OnPlayerLogout",
    "UpdateTeamInfo",
    "ChangeBuffTime",
    "RefreshSceneUI",
    "ShowAllSceneUI",
    "ShowSettlement",
    "SyncStageScore",
    "SyncStageStars",
    "SkinPartChange",
    "SetNoviceGuide",
    "setGuideTarget",
    "DelGuideTarget",
    "ShowNavigation",
    "NavCollapsible",
    "ShowKillerInfo",
    "HideKillerInfo",
    "ShowTargetInfo",
    "UpdataRankData",
    "SetBoundingBox",
    "SpawItemEffect",
    "SyncCameraMode",
    "ShowToolBarBtn",
    "ShowUpglideTip",
    "SyncEntityMode",
    "BuyVoiceResult",
    "SetGoldAppleHp",
    "SendGameResult",
    "UpdateTeamRank",
    "UpdateLeftTime",
    "RequestFriends",
    "QueryChestTray",
    "RemoveTrayItem",
    "FinishCompound",
    "OnPlayerInvite",
    "QueryPartyList",
    "QueryPartyInfo",
    "ChangTradeItem",
    "RequestAnimoji",
    "SaveEditObject",
    "SyncEditObject",
    "ResetEditQueue",
    "switchGameMode",
    "PlayerAutoKick",
    "CancelPayMoney",
    "EnterEditorMode",
    "syncTreasurebox",
    "AddEntityHeadUI",
    "CloseAllSceneUI",
    "PlayerScoreShow",
    "ShowGameQuality",
    "SetStageTopInfo",
    "SendChapterInfo",
    "ShowDeadSummary",
    "ShowUpgradeShop",
    "ShowNoviceGuide",
    "ShopGoodIsLimit",
    "FriendOperation",
    "AttachDebugPort",
    "DetachDebugPort",
    "ShowComposition",
    "ChangeCameraCfg",
    "PlayEffectByPos",
    "ShowTreasureBox",
    "ShowInputDialog",
    "TradeItemChange",
    "ShowLongTextTip",
    "ShowSumRecharge",
    "ShowChatChannel",
    "ForceMoveToSelf",
    "ResetItemSelect",
    "GetTeamHeadText",
    "ShowOverPopView",
    "SendRoomOwnerId",
    "UpdateWorldTime",
    "SwapComposition",
    "SwitchChestItem",
    "QuerySimpleView",
    "QueryPlayerlist",
    "AbandonTrayItem",
    "GetSignInReward",
    "OnWatchAdResult",
    "RequestJoinTeam",
    "OpenTreasureBox",
    "ResetGameFailed",
    "ReqTeammateInfo",
    "FollowEnterGame",
    "ConfirmPayMoney",
    "GetServerOsTime",
    "AddEntitySceneUI",
    "EntityDeadAction",
    "ShowRewardNotice",
    "EntityPlayAction",
    "ShowMerchantShop",
    "SetMapPlayerIcon",
    "ShowContentsList",
    "setGuidePosition",
    "ShowUINavigation",
    "OpenConversation",
    "ChangeCameraView",
    "ShowNumberEffect",
    "ShowImagesEffect",
    "SetEntityBodyYaw",
    "ShowTitleBarPage",
    "ShowAttackHitTip",
    "RefreshPartyList",
    "RefreshPartyInfo",
    "OperationWindows",
    "SumRechargeGCube",
    "ShowCenterFriend",
    "GotoTargetServer",
    "GetVoiceCardTime",
    "UpdatePlayerRank",
    "UpdateAliveCount",
    "UpdatePlayerInfo",
    "SwitchItemFailed",
    "DoRemoteCallback",
    "SupStartCompound",
    "RequestExitStage",
    "OnRechargeResult",
    "EditObjectAction",
    "RequestLeaveTeam",
    "IgnoreRenewParty",
    "RequestJoinParty",
    "GameExplainEvent",
    "ClickChangeBlock",
    "SetViewRangeSize",
    "ChangeEntityMode",
    "UpdateEditObject",
    "RemoveEditObject",
    "OnPlayerReconnect",
    "SendBuyShopResult",
    "SynCurrencySingle",
    "ObjectListRemoved",
    "ShowRewardRollTip",
    "SetHeartbeatSpeed",
    "ShowDeadCountDown",
    "StopDeadCountDown",
    "SyncStoreItemInfo",
    "UpdataTreasureBox",
    "SceneUiOperaction",
    "ShowPlayerKillTip",
    "TradePlayerCancel",
    "SumRechargeResult",
    "ShowSlidingPrompt",
    "AddCommonActivity",
    "MustLotteryDelete",
    "MustLotteryResult",
    "UpdateMovingStyle",
    "SyncBuyCommoditys",
    "IntegrateTypeTray",
    "RequestRankReward",
    "DropInventoryItem",
    "RequestCreateTeam",
    "ReplaceEditObject",
    "onbuyActionResult",
    "TouchClientEntity",
    "RemoveEntityHeadUI",
    "UpdateCountDownTip",
    "SendEnableChapters",
    "SendCompoundResult",
    "ShowTextUIOnEntity",
    "ShowGeneralOptions",
    "TradePlayerConfirm",
    "ShowEquipUpgradeUI",
    "ClearSlidingPrompt",
    "SyncCommonActivity",
    "LuckyLotteryResult",
    "BlindBoxOpenResult",
    "UpdateEntityHeadUI",
    "TakeOffComposition",
    "SwitchNpcChestItem",
    "LoadEnableChapters",
    "ReceivedStarReward",
    "InteractWithEntity",
    "SyncStoreOperation",
    "LoadTeamMemberInfo",
    "TreasureBoxResresh",
    "SumRechargeReceive",
    "GameBehaviorReport",
    "OtherClientHandler",
    "RemoveEntitySceneUI",
    "RefreshEntityHeadUI",
    "ShowStageSettlement",
    "CameraContorlSwitch",
    "ShowCardOptionsView",
    "SetEntityActorAlpha",
    "SetEntityActorScale",
    "ShowBackpackDisplay",
    "MarkEntityForPlayer",
    "UpdateSkillJackArea",
    "ShowAnimationReward",
    "ReceiveCenterFriend",
    "MultiStageSkillData",
    "SyncActionPriceList",
    "ChatMessageToFamily",
    "PlayBreakBlockSound",
    "SetForceMoveTimePos",
    "ShowPropCollectRank",
    "QueryEntityViewInfo",
    "SendFriendOperation",
    "PrepareToStartStage",
    "GuidePositionChange",
    "ButtonSetClickAction",
    "RefreshEntitySceneUI",
    "ShowNumberUIOnEntity",
    "ResreshTreasureBoxCd",
    "ShowRewardItemEffect",
    "ShowEditEntityPosRot",
    "RecalcCacheChunkData",
    "ClearMapClientEntity",
    "ClearAllClientEntity",
    "ServerPackageHandler",
    "DebugTransferRequest",
    "NoticeNotEnoughMoney",
    "RemoveCommonActivity",
    "MustLotteryDoLottery",
    "ChatMessageToPrivate",
    "BCUpdateEntityHeadUI",
    "RequestChangeGameKey",
    "ToolBarBtnClickEvent",
    "RequestCenterFriends",
    "ClientPackageHandler",
    "EspeciallyShop_update",
    "FriendOperationNotice",
    "UnMarkEntityForPlayer",
    "UpdateBgmPlayingIndex",
    "DebugTransferResponse",
    "ReceivedChapterReward",
    "RequestQuitTeamMember",
    "RequestChangeTeamGame",
    "SetReadyForAssignTeam",
    "SendBuyCommodityResult",
    "CreateMapClientEntitys",
    "RemoveMapClientEntitys",
    "LuckyLotteryDiscountCd",
    "ChatMessagePrivateSelf",
    "ClacTemporaryShieldBar",
    "UpdateScaleWhenRebirth",
    "FriendOperactionNotice",
    "RequestStartStageResult",
    "SceneEntityUiOperaction",
    "ShowObjectInteractionUI",
    "HideObjectInteractionUI",
    "SwitchInteractionWindow",
    "ShowGeneralOptionDerive",
    "CommonActivityOpenChest",
    "UpdateTeamAdditionalInfo",
    "ShowPersonalInformations",
    "ShowPlaySoundProgressBar",
    "RecheckAllInteractionUIs",
    "ShowPropCollectCountDown",
    "QueryCreatePartyViewInfo",
    "SetEntityActorFlashEffect",
    "ShowGenericListDisplayBox",
    "ShowGenericActorShowStore",
    "UpdateObjectInteractionUI",
    "UpdatePartyInnerSettingUI",
    "UpdateEntityEditContainer",
    "FollowInterfaceDataReport",
    "CommonActivityRefreshChest",
    "SendBuyCommodityShopIsLimit",
    "InteractionWithMovementEvent",
    "UpdateGeneralOptionsRightSide",
    "CommonActivityOpenChestResult",
    "UpdateGeneralOptionDeriveRight",
    "RequestUpdateTeamAdditionalInfo",
    "UpdatePlayerEquipAdditionalBuffList"
}

local StructKey = {
    "pid",
    "id",
    "map",
    "ret",
    "pos",
    "msg",
    "uid",
    "key",
    "yaw",
    "ary",
    "cmd",
    "min",
    "max",
    "tid",
    "add",
    "val",
    "cfg",
    "arr",
    "pic",
    "typ",
    "m_x",
    "m_y",
    "m_z",
    "idx",
    "bag",
    "cid",
    "fps",
    "name",
    "isUp",
    "time",
    "mode",
    "skin",
    "info",
    "list",
    "item",
    "vars",
    "type",
    "args",
    "open",
    "data",
    "show",
    "text",
    "path",
    "coin",
    "cost",
    "sure",
    "view",
    "slot",
    "pack",
    "size",
    "rate",
    "flag",
    "isMe",
    "area",
    "ping",
    "menu",
    "obj1",
    "obj2",
    "tid2",
    "tid1",
    "step",
    "code",
    "test",
    "star",
    "tray",
    "keys",
    "desc",
    "mapId",
    "objID",
    "state",
    "objId",
    "limit",
    "cfgID",
    "curHp",
    "curVp",
    "pitch",
    "shake",
    "value",
    "score",
    "regId",
    "stars",
    "stage",
    "title",
    "tipID",
    "close",
    "image",
    "index",
    "class",
    "delay",
    "param",
    "adsId",
    "mapID",
    "times",
    "ranks",
    "alpha",
    "store",
    "scale",
    "uiCfg",
    "start",
    "count",
    "frame",
    "gcube",
    "color",
    "price",
    "props",
    "super",
    "emoji",
    "atlas",
    "tid_1",
    "tid_2",
    "slot1",
    "slot2",
    "speed",
    "sells",
    "check",
    "objIDs",
    "teamID",
    "teamId",
    "wallet",
    "fromID",
    "values",
    "uiData",
    "reason",
    "textP1",
    "uiName",
    "result",
    "finish",
    "isKick",
    "action",
    "cancel",
    "userId",
    "status",
    "button",
    "params",
    "smooth",
    "config",
    "switch",
    "entity",
    "packet",
    "errMsg",
    "myrank",
    "number",
    "imgset",
    "imgfmt",
    "images",
    "infoTb",
    "isOpen",
    "isShow",
    "cfgKey",
    "remind",
    "gameId",
    "aimPos",
    "method",
    "cdTime",
    "tittle",
    "fromId",
    "events",
    "target",
    "hAlign",
    "vAlign",
    "motion",
    "bagTid",
    "slot_1",
    "slot_2",
    "objID1",
    "indexs",
    "varKey",
    "isEdit",
    "damage",
    "myRanks",
    "winName",
    "started",
    "old_obj",
    "new_obj",
    "textKey",
    "session",
    "cfgName",
    "startTs",
    "succeed",
    "flyMode",
    "tipType",
    "content",
    "pyramid",
    "targets",
    "colBool",
    "btsList",
    "storeId",
    "tradeID",
    "friends",
    "package",
    "hookPos",
    "blockId",
    "isTouch",
    "needPre",
    "linePos",
    "tiptext",
    "options",
    "npcList",
    "headHit",
    "gravity",
    "msgPack",
    "extraHp",
    "handTid",
    "bagSlot",
    "context",
    "dropTid",
    "modName",
    "message",
    "btnType",
    "gameKey",
    "partyId",
    "boxName",
    "ownerID",
    "rankType",
    "rankData",
    "myScores",
    "blockPos",
    "targetID",
    "textArgs",
    "targetId",
    "audioDir",
    "gameMode",
    "navRegId",
    "leaderId",
    "handItem",
    "rideOnId",
    "headText",
    "buffList",
    "isPlayer",
    "entityUI",
    "curMapUI",
    "moveTime",
    "keepTime",
    "fromname",
    "textIcon",
    "oldScore",
    "fullName",
    "itemData",
    "showType",
    "skinData",
    "interval",
    "shopType",
    "distance",
    "filename",
    "rankName",
    "boxTable",
    "textList",
    "justSelf",
    "isBigNum",
    "closeWin",
    "imageset",
    "buffTime",
    "buffName",
    "excluded",
    "chunkPos",
    "coinName",
    "runStart",
    "onlySelf",
    "startPos",
    "itemName",
    "showMask",
    "contents",
    "isCancel",
    "parentUi",
    "talkList",
    "headInfo",
    "sortGist",
    "pageSize",
    "showTime",
    "autoCast",
    "handSlot",
    "lastTime",
    "trayType",
    "petIndex",
    "chestPos",
    "dropSlot",
    "item_num",
    "cfgIndex",
    "btnIndex",
    "memberId",
    "actionId",
    "playerId",
    "sourceId",
    "actorName",
    "touchTime",
    "targetPos",
    "worldTime",
    "debugport",
    "teamsInfo",
    "gameState",
    "itemIndex",
    "rideOnIdx",
    "moveSpeed",
    "guardTime",
    "rideOffId",
    "clearSkin",
    "chapterId",
    "isWatcher",
    "showTitle",
    "showGroup",
    "shopGroup",
    "sessionId",
    "serialNum",
    "viewIndex",
    "imagePath",
    "updateWin",
    "partyData",
    "targetUid",
    "tradeItem",
    "isConfrim",
    "operation",
    "pullTimes",
    "targetDir",
    "optionNpc",
    "showLines",
    "titleText",
    "nextStage",
    "stageName",
    "totalTime",
    "m_success",
    "m_ctrlVer",
    "voiceTime",
    "isSucceed",
    "fromObjID",
    "canRevive",
    "targetTid",
    "increment",
    "partyName",
    "tray_data",
    "item_data",
    "dropCount",
    "typeIndex",
    "refreshUI",
    "productId",
    "isConfirm",
    "sideNormal",
    "playerInfo",
    "createTime",
    "updateInfo",
    "passengers",
    "openParams",
    "guideSpeed",
    "recipeName",
    "regionInfo",
    "effectPath",
    "targetInfo",
    "remainTime",
    "imageWidth",
    "showFuncId",
    "dropItemId",
    "actionList",
    "isRecalced",
    "tittletext",
    "playerName",
    "endSubTime",
    "entityType",
    "optionList",
    "buttonInfo",
    "totalScore",
    "targetAddr",
    "serverPort",
    "m_entityId",
    "lineRotate",
    "targetName",
    "aliveCount",
    "targetSlot",
    "clientData",
    "equipSkill",
    "isREPLMode",
    "resreshTyp",
    "resultCode",
    "resultType",
    "actionTime",
    "chapterInfo",
    "__session__",
    "entitysInfo",
    "removeValue",
    "isGameParty",
    "playersInfo",
    "forceUpdate",
    "rotationYaw",
    "movingStyle",
    "cameraParam",
    "notHideMain",
    "newReviveUI",
    "FollowObjID",
    "imageHeight",
    "isOpenChild",
    "channelName",
    "clientAdded",
    "sustainTime",
    "addCapacity",
    "lastLinePos",
    "defaulIndex",
    "targetObjID",
    "roomOwnerId",
    "extraHpLeft",
    "targetCurHp",
    "create_data",
    "crossServer",
    "targetIndex",
    "targetObjId",
    "mapChunkData",
    "joinTeamTime",
    "rotationRoll",
    "isBigInteger",
    "isNextServer",
    "skinPartData",
    "guideTexture",
    "relativeSize",
    "playingIndex",
    "pickEntityId",
    "itemFullName",
    "forcedChoice",
    "contentsIcon",
    "contentsList",
    "startSubTime",
    "historyScore",
    "m_resultCode",
    "linePosValue",
    "targetUserId",
    "updateStatus",
    "noSyncClient",
    "isTimeStopped",
    "rotationPitch",
    "entityToBlock",
    "actionCfgName",
    "operationType",
    "needShowGuide",
    "isMoreTargets",
    "CountdownTime",
    "selectedIndex",
    "leftSideWidth",
    "equipSkillBar",
    "additionalInfo",
    "enableChapters",
    "newRegionInfos",
    "delRegionInfos",
    "hasChangeImage",
    "beginOffsetPos",
    "contentsTittle",
    "collectorsName",
    "vectorEntityId",
    "inPartyOwnerId",
    "lastLineRotate",
    "isPutIntoChest",
    "canAddCapacity",
    "oldTeamLeaderId",
    "isNeedTranslate",
    "touchActionTime",
    "currentCapacity",
    "callBackModName",
    "m_serverVersion",
    "merchantGroupName",
    "clientEntityObjId",
    "flashBeforeMissing",
    "isMultilineStatement",
    "isEditorServerEnvironment",
    "followTargetPositionOffset",
    "followTargetRotationOffset"
}

local function init()
    for _, v in ipairs(PacketName) do
        Packet.RegisterPacketPid(v)
    end
    for _, v in ipairs(StructKey) do
        Packet.RegisterPacketStruct(v)
    end
    PidNumber = (math.ceil(PidNumber / 100) + 1) * 100
    StructNumber = (math.ceil(StructNumber / 100) + 1) * 100
end

init()
