---
--- Generated by PluginCreator
--- easter_eggs entity
--- DateTime:2022-03-15
---

local Entity = Entity

---@type LuaTimer
local LuaTimer = T(Lib, "LuaTimer")

--- @type EasterEggsManager
local EasterEggsManager = T(Lib, "EasterEggsManager")

function Entity:isEasterEggs()
    return self.easterEggObj ~= nil
end

function Entity:getEasterEggs()
    return self.easterEggObj
end

function Entity:checkShowEasterEggRefreshTime()
    if not self:isEasterEggs() then
        return false
    end

    local value = self:getEggEntityRefreshTime()
    local info = Me:getEasterEggState()
    if info[value.eggId] == 1 then
        self:showEasterEggRefreshTime()
    else
        self:hideEasterEggRefreshTime()
    end
end

function Entity:showEasterEggRefreshTime(id, refreshTime)
    local time = refreshTime - os.time()
    if time > 0 then
        local eggHeadTextTimer = Me:data("main").eggHeadTextTimer or {}
        if eggHeadTextTimer and eggHeadTextTimer[id] then
            LuaTimer:cancel(eggHeadTextTimer[id])
            eggHeadTextTimer[id] = nil
        end

        eggHeadTextTimer[id]= LuaTimer:scheduleTimer(function()
            if self and self:isValid() then
                time = refreshTime - os.time()
                local seconds = math.floor(time%60)
                local min = math.floor((time/60) %60)
                local hour = math.floor(time/3600)
                local decTime = hour..":"..min..":"..seconds

                self:setHeadText(0, -3, "")
                self:setHeadText(0, -2, Lang:toText("ui.easter.countdown"))
                self:setHeadText(0, -1, decTime)
                self:updateShowName()

                if time <= 0 then
                    LuaTimer:cancel(eggHeadTextTimer[id])
                    eggHeadTextTimer[id] = nil
                    Me:data("main").boxHeadTextTimer = eggHeadTextTimer
                end
            else
                LuaTimer:cancel(eggHeadTextTimer[id])
                eggHeadTextTimer[id] = nil
                Me:data("main").boxHeadTextTimer = eggHeadTextTimer
                return
            end
        end, 1000, time, nil)

        Me:data("main").boxHeadTextTimer = eggHeadTextTimer
    end
end

function Entity:hideEasterEggRefreshTime(id)
    local eggHeadTextTimer = Me:data("main").eggHeadTextTimer or {}
    local luaTimerId = eggHeadTextTimer[id]
    if luaTimerId then
        LuaTimer:cancel(eggHeadTextTimer[id])
        eggHeadTextTimer[id] = nil
        Me:data("main").boxHeadTextTimer = eggHeadTextTimer
    end

    self:setHeadText(0, -3, "")
    self:setHeadText(0, -2, "")
    self:setHeadText(0, -1, "")
    self:updateShowName()
end